---
date: "2024-06-23 21:22:25 +0900"
last_modified_at: "2024-09-21 14:04:11 +0900"
title: "2024-06-23"
---

# 2024-06-23
## rails ã« vite, TypeScript, React å°å…¥
### ç¾åœ¨
importmaps ã«ã—ã¦ã„ã‚‹ã€‚ã¡ã‚ƒã‚“ã¨ bundle ã™ã‚‹å½¢ã«ã—ãŸã„  
importmaps ã ã¨ React ã¯ jsx ä½¿ãˆãªã„ã‚‰ã—ã„ï¼ˆè¦å‡ºå…¸ï¼‰

### å‚è€ƒ

https://zenn.dev/salvage0707/scraps/1bd24c3293d85c

`home#index` ä½œã‚‹  
ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆãŒ `app/frontend/entrypoints/application.js` ã“ã‚Œã‚’ front/entrypoints ã«ã—ãŸã„ã€‚vite_rails ã§ã§ãã‚‹ã¯ãš  
`yarn create vite frontend --template react-ts` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚frontend directory ãŒã§ãã‚‹ã®ã ãª  
`frontend/app/application.ts` ã¯ãªã‚“ãªã‚“ã ã‚ã†ã‹ï¼Ÿ  

---

https://www.mof-mof.co.jp/tech-blog/2024/04/22/124028

ã“ã‚Œã¯ TypeScript + React  

`front#index` ã‚’ç”¨æ„ã—ã¦ãã® `app/views/top/index.html.erb` ã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹å½¢

### vite_rails

```rb
gem 'vite_rails' # vite_rails_legacy if using Rails 4
```

```
$ bundle install
If you upgraded the gem manually, please run:
        bundle exec vite upgrade

# ä¸€å¿œã‚„ã£ã¦ãŠã
$ bundle exec vite upgrade
No such file or directory - npm

```

### node ä½¿ãˆã‚‹ç’°å¢ƒã«ã—ãªã„ã¨ã„ã‘ãªã„

.devcontainers/Dockerfile ã®ã»ã†ã«ã“ã‚Œã‚’è¿½è¨˜

```
# Install Node.js and yarn
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl gnupg && \
    curl -sL https://deb.nodesource.com/setup_current.x | bash - && \
    apt-get install -y nodejs && \
    npm install --global yarn && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*
```

yarn ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ 1.22.22

### reinstall vite_rails

```
Gemfile ã‹ã‚‰å‰Šé™¤ã—ã¦
$ ./bin/bundle clean
$ ./bin/bundle
```

```sh
$ ./bin/bundle exec vite upgrade
Updating gems
Fetching gem metadata from https://rubygems.org/.........
Resolving dependencies...
Resolving dependencies...
Fetching minitest 5.24.0 (was 5.23.1)
Fetching rack 3.1.4 (was 3.1.3)
Fetching zeitwerk 2.6.16 (was 2.6.15)
Fetching irb 1.13.2 (was 1.13.1)
Installing zeitwerk 2.6.16 (was 2.6.15)
Installing minitest 5.24.0 (was 5.23.1)
Installing rack 3.1.4 (was 3.1.3)
Installing irb 1.13.2 (was 1.13.1)
Bundle updated!
1 installed gem you directly depend on is looking for funding.
  Run `bundle fund` for details
Upgrading npm packages # ä»Šåº¦ã¯ã“ã‘ãšã«æ¸ˆã‚“ã ã

added 31 packages in 8s

6 packages are looking for funding
  run `npm fund` for details
```

```
$ ./bin/bundle exec vite install
Creating binstub
Check that your vite.json configuration file is available in the load path:

        No such file or directory @ rb_sysopen - /workspaces/rails-playground/config/vite.json

Creating configuration files
Installing sample files
Installing js dependencies

added 1 package, and audited 33 packages in 962ms

6 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
Adding files to .gitignore

Vite âš¡ï¸ Ruby successfully installed! ğŸ‰
```

#### bundle exec vite install ã§å‡ºæ¥ä¸ŠãŒã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¿ã‚‹

```
 â¯ git st
On branch introduce-vite_rails
Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   .gitignore
	modified:   Gemfile
	modified:   Gemfile.lock
	modified:   Procfile.dev
	modified:   app/views/layouts/application.html.erb
	modified:   config/initializers/content_security_policy.rb

# ã“ã“ã‚‰è¾ºãŒæ–°ãŸã«ã§ããŸãƒ•ã‚¡ã‚¤ãƒ«
Untracked files:
  (use "git add <file>..." to include in what will be committed)
	app/javascript/entrypoints/
	bin/vite
	config/vite.json
	package-lock.json
	package.json
	vite.config.ts
```

ç·¨é›†ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹

```diff
diff --git a/Procfile.dev b/Procfile.dev
index da151fe..e6ad037 100644
--- a/Procfile.dev
+++ b/Procfile.dev
@@ -1,2 +1,3 @@
 web: bin/rails server
 css: bin/rails tailwindcss:watch
+vite: bin/vite dev


# app/javascript/entrypoints/application.js ãŒã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã«ãªã‚‹ã®ã ãª

diff --git a/app/views/layouts/application.html.erb b/app/views/layouts/application.html.erb
index 5374b55..366cfc6 100644
--- a/app/views/layouts/application.html.erb
+++ b/app/views/layouts/application.html.erb
@@ -16,6 +16,18 @@
     <%= stylesheet_link_tag "tailwind", "inter-font", "data-turbo-track": "reload" %>
     <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
     <%= javascript_importmap_tags %>
+    <%= vite_client_tag %>
+    <%= vite_javascript_tag 'application' %>
+    <!--
+      If using a TypeScript entrypoint file:
+        vite_typescript_tag 'application'
+
+      If using a .jsx or .tsx entrypoint, add the extension:
+        vite_javascript_tag 'application.jsx'
+
+      Visit the guide for more information: https://vite-ruby.netlify.app/guide/rails
+    -->
+
   </head>

   <body>

diff --git a/config/initializers/content_security_policy.rb b/config/initializers/content_security_policy.rb
index b3076b3..aa21c5f 100644
--- a/config/initializers/content_security_policy.rb
+++ b/config/initializers/content_security_policy.rb
@@ -11,7 +11,16 @@
 #     policy.img_src     :self, :https, :data
 #     policy.object_src  :none
 #     policy.script_src  :self, :https
+    # Allow @vite/client to hot reload javascript changes in development
+#    policy.script_src *policy.script_src, :unsafe_eval, "http://#{ ViteRuby.config.host_with_port }" if Rails.env.development?
+
+    # You may need to enable this in production as well depending on your setup.
+#    policy.script_src *policy.script_src, :blob if Rails.env.test?
+
 #     policy.style_src   :self, :https
+    # Allow @vite/client to hot reload style changes in development
+#    policy.style_src *policy.style_src, :unsafe_inline if Rails.env.development?
+
 #     # Specify URI for violation reports
 #     # policy.report_uri "/csp-violation-report-endpoint"
 #   end
```

---

```
[54085 ms] Port forwarding 51341 > 45037 > 45037 stderr: Connection established
[55096 ms] rejected promise not handled within 1 second: Error: connect ECONNREFUSED 127.0.0.1:3000
stack trace: Error: connect ECONNREFUSED 127.0.0.1:3000
    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1595:16)
[08:44:36] Error: connect ECONNREFUSED 127.0.0.1:3000
    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1595:16) {
  errno: -111,
  code: 'ECONNREFUSED',
  syscall: 'connect',
  address: '127.0.0.1',
  port: 3000
}
```

ã†ãƒ¼ã‚“ã€ä¸Šè¨˜ã¯ bin/setup ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŒã€ã©ã†ã‚‚ã†ã¾ãå‹•ã„ã¦ã„ãªã„ãªã‚ï¼Ÿ  

bin/dev ã ã¨ foreman ã§èµ·å‹•ã—ã¦ãã‚Œã‚‹ã®ã ãŒ

```
08:47:30 web.1  | * Listening on http://127.0.0.1:3000
08:47:30 web.1  | * Listening on http://[::1]:3000
```

vite ã‚‚3036 ã§ç«‹ã¡ä¸ŠãŒã‚‹ã€‚auto forwarded ã‚‰ã—ã„ã€‚ã¤ã¾ã‚Š .devcontainer.json ã® forwardPorts ã§æŒ‡å®šã—ã¦ã„ãªãã¦ã‚‚è‰¯ã•ãã†

```
08:53:18 vite.1 |   VITE v5.3.1  ready in 238 ms
08:53:18 vite.1 | 
08:53:18 vite.1 |   âœ  Local:   http://localhost:3036/vite-dev/
08:53:18 vite.1 |   âœ  press h + enter to show help
h
08:53:40 vite.1 | 
08:53:40 vite.1 |   Shortcuts
08:53:40 vite.1 |   press r + enter to restart the server
08:53:40 vite.1 |   press u + enter to show server url
08:53:40 vite.1 |   press o + enter to open in browser
08:53:40 vite.1 |   press c + enter to clear console
08:53:40 vite.1 |   press q + enter to quit

# oã¯ãƒ€ãƒ¡ã£ã½ã„
o
08:53:56 vite.1 | Error: spawn xdg-open ENOENT
08:53:56 vite.1 |     at ChildProcess._handle.onexit (node:internal/child_process:286:19)
08:53:56 vite.1 |     at onErrorNT (node:internal/child_process:484:16)
08:53:56 vite.1 |     at process.processTicksAndRejections (node:internal/process/task_queues:82:21)

u
08:54:03 vite.1 | 
08:54:03 vite.1 |   âœ  Local:   http://localhost:3036/vite-dev/
# ãšã£ã¨ãƒªãƒ­ãƒ¼ãƒ‰çŠ¶æ…‹ã«ãªã£ã¦ä½•ã«ã‚‚ç¢ºèªã§ãã‚“
```

#### /workspaces/rails-playground/app/javascript/entrypoints/application.js ã‚’ç·¨é›†ã—ã¦ã¿ã‚‹
ãƒ­ã‚°ã§ Rebuilding... ã¨ãªã‚‹ã®ã§ HMR ã¯åŠ¹ã„ã¦ã„ã‚‹ã‚ˆã†ã ï¼Ÿ

layout file ã‚’ application ã¨ã¯åˆ¥ã« articles ã¨ã„ã†ã‚‚ã®ã‚’ç”¨æ„ã—ã¦ã„ãŸã®ã§ã€ãã“ã§ vite_javascript_tag ãªã©ã‚’è¨­å®šã—ãªã„ã¨ã„ã‘ãªã‹ã£ãŸ

ã¨ã‚Šã‚ãˆãš application, articles ä¸¡æ–¹ã§åŒã˜ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ãŒã€åˆ¥ã€…ã®ã»ã†ãŒã‚ˆã‹ã£ãŸã‚Šã™ã‚‹ã®ã‹ãªï¼Ÿ

application layout ã‚’ä½¿ç”¨ã™ã‚‹åˆ¥ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ç”¨æ„ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚

#### importmaps ã¨ vite_rails ã®ä½µç”¨
turbo-rails, stimulus ã¯ importmaps ã§å…¥ã‚Œã¦ã„ã‚‹ã€‚ã€‚ã€‚ã®ã§ã‚ã‚Œã°ãã‚Œã¯ãã‚Œã§è‰¯ã•ãã†

vite_rails ã¯å®Œå…¨ã« front å´ã‚’ç®¡ç†ã™ã‚‹ã®ã«å¾¹ã™ã‚Œã°ã„ã‘ã‚‹ã‹ãªï¼Ÿ


ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒ devtools console ã§å‡ºã¦ã—ã¾ã†ã€‚ã—ã‹ã— `type="module"` ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚ˆã‚Šå…ˆã«èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã®ã ãŒâ€¦

An import map is added after module script load was triggered.

https://github.com/ElMassimo/vite_ruby/issues/417#issuecomment-1946414689

`preload_links_header: false` ã«ã—ãªã„ã¨ã„ã‘ãªã„ã®ã‹ãªã‚

----

### entrypoints ã‚’å¤‰æ›´ã™ã‚‹
`app/javascript/entrypoints/application.ts` ã‚’ `front/entrypoints/application.ts` ã«å¤‰æ›´ã™ã‚‹

https://vite-ruby.netlify.app/config/index.html#sourcecodedir

`sourceCodeDir` ã‚’ `front` ã«å¤‰æ›´ã™ã‚‹ã€‚ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¯ãã“ã‹ã‚‰ã®ç›¸å¯¾ã§ã‚ã‚‹ `entrypointsDir` `front/entrypoints` ã«å¤‰æ›´ã•ã‚Œã‚‹

tailwind ã®è¨­å®šã§ã¯ã“ã†ãªã£ã¦ã„ã‚‹ã€‚front å´ã® React component ã«ã‚‚é©ç”¨ã•ã‚Œã‚‹ã®ã ã‚ã†ã‹ï¼Ÿ

`'./app/javascript/**/*.js',`

### importmaps ã¨ vite_rails ã®ä½µç”¨ã¨ã„ã†ã‹å…±å­˜ã¨ã„ã†ã‹

importmaps -> Turbo ã‚’ä½¿ã£ã¦ã„ã‚‹
ä½¿ã„ãŸããªã„ã¨ã“ã‚ã§ã¯ javascript_importmap_tags ã‚’ä½¿ã‚ãªã‘ã‚Œã°è‰¯ã„ã®ã§ã¯ï¼Ÿ
åˆ¥ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦æ¤œè¨¼ã™ã‚‹

app/controllers/front/articles_controller.rb

```rb
class Front::ApplicationController < ApplicationController
  layout 'front'
end
```

```rb
class Front::ArticlesController < Front::ApplicationController
  layout 'front'
  def index
  end
end
```

front layout ã§ã¯ vite_typescript_tag ã‚’ä½¿ã†

Turbo ãŒåŠ¹ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã‹ã‚‰é·ç§»ã—ã¦ããŸæ™‚ã¯ã©ã†ãªã‚‹ã‚“ã ã‚ã†
